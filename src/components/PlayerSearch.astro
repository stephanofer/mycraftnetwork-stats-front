---
---

<div class="player-search" id="player-search">
  <form class="search-form" id="search-form" action="/player" method="get">
    <div class="search-input-wrapper">
      <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
        <path fill="currentColor" d="m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3zM9.5 14q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14"/>
      </svg>
      <input 
        type="text" 
        name="q"
        id="search-input"
        class="search-input" 
        placeholder="Buscar jugador..."
        autocomplete="off"
        autocapitalize="off"
        spellcheck="false"
        minlength="3"
        maxlength="16"
        pattern="[a-zA-Z0-9_]{3,16}"
        title="Nombre de usuario (3-16 caracteres, solo letras, números y guión bajo)"
        aria-label="Buscar jugador por nombre de usuario"
      />
      <button 
        type="button" 
        class="clear-button" 
        id="clear-button" 
        aria-label="Limpiar búsqueda"
        hidden
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
          <path fill="currentColor" d="M18.984 6.422L13.406 12l5.578 5.578l-1.406 1.406L12 13.406l-5.578 5.578l-1.406-1.406L10.594 12L5.016 6.422l1.406-1.406L12 10.594l5.578-5.578z"/>
        </svg>
      </button>
    </div>
    <button type="submit" class="search-button" id="search-button" aria-label="Buscar">
      <span class="button-text">Buscar</span>
      <svg class="button-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
        <path fill="currentColor" d="M4 11v2h12l-5.5 5.5l1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5L16 11z"/>
      </svg>
    </button>
  </form>
  <div class="search-message" id="search-message" hidden></div>
</div>

<style>
  .player-search {
    position: relative;
    width: 100%;
    max-width: 400px;
  }

  .search-form {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--color-divider);
    border-radius: 0.75rem;
    padding: 0.35rem 0.5rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .search-form:focus-within {
    border-color: var(--resalt);
    background: rgba(255, 255, 255, 0.05);
    box-shadow: 0 0 0 3px rgba(0, 118, 209, 0.15);
  }

  .search-input-wrapper {
    display: flex;
    align-items: center;
    flex: 1;
    gap: 0.5rem;
    min-width: 0;
  }

  .search-icon {
    color: var(--color-opacity);
    flex-shrink: 0;
    transition: color 0.2s ease;
  }

  .search-form:focus-within .search-icon {
    color: var(--resalt);
  }

  .search-input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: white;
    font-family: "Inter", sans-serif;
    font-size: var(--fs-sm);
    min-width: 0;
    padding: 0.4rem 0;
  }

  .search-input::placeholder {
    color: var(--color-opacity);
    transition: color 0.2s ease;
  }

  .search-input:focus::placeholder {
    color: rgba(129, 129, 129, 0.5);
  }

  .clear-button {
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: var(--color-opacity);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 50%;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  .clear-button:hover {
    color: white;
    background: rgba(255, 255, 255, 0.1);
  }

  .clear-button[hidden] {
    display: none;
  }

  .search-button {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    background: var(--resalt);
    color: white;
    border: none;
    border-radius: 0.5rem;
    padding: 0.5rem 0.85rem;
    font-family: "Inter", sans-serif;
    font-size: var(--fs-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    flex-shrink: 0;
  }

  .search-button:hover {
    background: #0084d0;
    transform: translateY(-1px);
  }

  .search-button:active {
    transform: translateY(0);
  }

  .search-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .button-icon {
    transition: transform 0.2s ease;
  }

  .search-button:hover .button-icon {
    transform: translateX(2px);
  }

  .search-message {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    margin-top: 0.5rem;
    padding: 0.75rem 1rem;
    background: rgba(20, 20, 20, 0.95);
    border: 1px solid var(--color-divider);
    border-radius: 0.5rem;
    font-size: var(--fs-sm);
    color: var(--color-opacity);
    z-index: 100;
    animation: slideDown 0.2s ease;
  }

  .search-message[hidden] {
    display: none;
  }

  .search-message.error {
    border-color: #ff4444;
    color: #ff6b6b;
  }

  .search-message.loading {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-0.5rem);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Mobile styles */
  @media (max-width: 768px) {
    .button-text {
      display: none;
    }

    .search-button {
      padding: 0.5rem;
    }

    .player-search {
      max-width: 280px;
    }
  }

  @media (max-width: 480px) {
    .player-search {
      max-width: 200px;
    }

    .search-input::placeholder {
      font-size: 0.75rem;
    }
  }
</style>

<script>
  document.addEventListener('astro:page-load', () => {
    const form = document.getElementById('search-form') as HTMLFormElement;
    const input = document.getElementById('search-input') as HTMLInputElement;
    const clearButton = document.getElementById('clear-button') as HTMLButtonElement;
    const searchButton = document.getElementById('search-button') as HTMLButtonElement;
    const message = document.getElementById('search-message') as HTMLDivElement;

    const usernameRegex = /^[a-zA-Z0-9_]{3,16}$/;

    input.addEventListener('input', () => {
      clearButton.hidden = input.value.length === 0;
      hideMessage();
    });

    clearButton.addEventListener('click', () => {
      input.value = '';
      clearButton.hidden = true;
      input.focus();
      hideMessage();
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const query = input.value.trim();
      
      if (query.length < 3) {
        showMessage('El nombre debe tener al menos 3 caracteres', 'error');
        return;
      }

      if (query.length > 16) {
        showMessage('El nombre no puede tener más de 16 caracteres', 'error');
        return;
      }

      if (!usernameRegex.test(query)) {
        showMessage('Solo letras, números y guión bajo permitidos', 'error');
        return;
      }

      window.location.href = `/player/${encodeURIComponent(query)}`;
    });

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        input.blur();
        hideMessage();
      }
    });

    function showMessage(text: string, type: 'error' | 'loading' = 'error') {
      message.textContent = text;
      message.className = `search-message ${type}`;
      message.hidden = false;
    }

    function hideMessage() {
      message.hidden = true;
    }

    document.addEventListener('click', (e) => {
      if (!form.contains(e.target as Node)) {
        hideMessage();
      }
    });
  });
</script>
